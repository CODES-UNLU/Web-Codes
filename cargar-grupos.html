<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cargar/Actualizar Grupos de WhatsApp | CODES++</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script>(function(){try{var t=localStorage.getItem('theme');if(t){document.documentElement.setAttribute('data-theme',t);}}catch(e){}})();</script>
</head>
<body>
  <header id="header">
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container">
        <a class="navbar-brand" href="index.html">
          <img src="assets/images/Logo.svg" alt="Logo CODES++" class="navbar-logo" />
        </a>
        <div class="navbar-actions d-flex gap-2 me-3">
          <a href="gruposswpp.html" class="btn btn-outline-primary btn-sm" id="backToGroupsBtn" title="Volver a grupos por cuatrimestre">
            <i class="bi bi-arrow-left-short"></i>
            <span class="d-none d-sm-inline">Volver a Grupos</span>
          </a>
          <button class="btn btn-outline-secondary btn-sm" id="darkModeToggle" title="Modo oscuro">
            <i class="bi bi-moon"></i>
          </button>
        </div>
      </div>
    </nav>
  </header>

  <main class="container" style="padding-top: 120px;">
    <h1 class="section-title text-center">Cargar/Actualizar enlace de grupo</h1>
    <p class="section-subtitle text-center">Elegí la materia, pegá el link del grupo y guardá. Si ya existe, se mostrará el actual y se actualizará.</p>

    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card p-4 mb-4">
          <form id="groupForm" class="row g-3">
            <div class="col-12">
              <label for="plan" class="form-label fw-semibold">Plan (obligatorio)</label>
              <select id="plan" class="form-select" required>
                <option value="" selected disabled>Seleccionar plan</option>
                <option value="1714">17.14 (actual)</option>
                <option value="1713">17.13</option>
              </select>
            </div>
            <div class="col-12">
              <label for="materia" class="form-label fw-semibold">Materia</label>
              <select id="materia" class="form-select" required disabled>
                <option value="">Seleccionar materia</option>
              </select>
              <div class="form-text">Primero elegí el plan para ver las materias disponibles.</div>
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Link actual (si existe)</label>
              <div id="linkActual" class="alert alert-light border d-flex align-items-center justify-content-between" role="alert">
                <span class="text-muted">Sin enlace cargado</span>
                <a id="linkActualHref" href="#" target="_blank" class="btn btn-sm btn-outline-primary d-none"><i class="bi bi-box-arrow-up-right me-1"></i>Abrir</a>
              </div>
            </div>
            <div class="col-12">
              <label for="nuevoLink" class="form-label fw-semibold">Nuevo enlace del grupo</label>
              <input type="url" id="nuevoLink" class="form-control" placeholder="https://chat.whatsapp.com/..." required />
              <div class="form-text">Debe comenzar con https:// y ser un enlace válido.</div>
            </div>
            <div class="col-md-6">
              <label for="nombre" class="form-label">Tu nombre (opcional)</label>
              <input type="text" id="nombre" class="form-control" placeholder="Quién carga/actualiza" />
            </div>
            <div class="col-12 d-flex gap-2">
              <button type="submit" class="btn btn-primary"><i class="bi bi-save me-2"></i>Guardar</button>
              <button type="button" id="btnVerTodos" class="btn btn-outline-secondary"><i class="bi bi-list-ul me-2"></i>Ver todos</button>
            </div>
          </form>
        </div>

        <div class="card p-3">
          <h5 class="mb-3"><i class="bi bi-collection me-2"></i>Grupos cargados</h5>
          <div id="tablaGrupos" class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Materia</th>
                  <th>Enlace</th>
                  <th>Actualizado</th>
                </tr>
              </thead>
              <tbody id="tbodyGrupos">
                <tr><td colspan="4" class="text-muted">Sin datos</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer id="contacto" class="mt-5">
    <div class="container">
      <div class="footer-content">
        <h3 class="footer-title">Centro Organizado de Estudiantes de Sistemas - CODES++</h3>
        <div class="contact-item"><i class="bi bi-envelope-fill"></i> <a href="mailto:codes.unlu@gmail.com">codes.unlu@gmail.com</a></div>
        <p class="mt-4 mb-0" style="opacity:.8; font-size:.9rem">© 2025 CODES++</p>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/groups.js"></script>
  <script>
    // Dark mode toggle minimal
    document.addEventListener('DOMContentLoaded', function(){
      const toggle = document.getElementById('darkModeToggle');
      if (toggle) {
        const icon = toggle.querySelector('i');
        const current = document.documentElement.getAttribute('data-theme') || 'light';
        if (icon) icon.className = current === 'dark' ? 'bi bi-sun' : 'bi bi-moon';
        toggle.addEventListener('click', function(){
          const next = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
          if (icon) icon.className = next === 'dark' ? 'bi bi-sun' : 'bi bi-moon';
        });
      }
    });

    // Populate materias
    function populateMaterias() {
      const sel = document.getElementById('materia');
      const planVal = document.getElementById('plan').value;
      if (!planVal) {
        sel.innerHTML = '<option value="">Seleccionar materia</option>';
        sel.disabled = true;
        return;
      }
      const list = Groups.getMateriasByPlan(planVal);
      sel.innerHTML = '<option value="">Seleccionar materia</option>' +
        list.map(m => `<option value="${m.code}">${m.code} - ${m.name}</option>`).join('');
      sel.disabled = false;
    }

    // Load current link when selecting materia
    async function loadCurrentLink(code) {
      const infoBox = document.getElementById('linkActual');
      const hrefBtn = document.getElementById('linkActualHref');
      infoBox.classList.remove('alert-info','alert-warning','alert-success');
      infoBox.classList.add('alert-light');
      infoBox.querySelector('span').textContent = 'Buscando...';
      hrefBtn.classList.add('d-none');
      try {
        const plan = document.getElementById('plan').value || '1714';
        const data = await Groups.fetchGroupByCode(code, plan);
        if (data && data.link) {
          infoBox.classList.remove('alert-light');
          infoBox.classList.add('alert-info');
          infoBox.querySelector('span').textContent = data.link;
          hrefBtn.href = data.link;
          hrefBtn.classList.remove('d-none');
        } else {
          infoBox.classList.remove('alert-info');
          infoBox.classList.add('alert-light');
          infoBox.querySelector('span').textContent = 'Sin enlace cargado';
        }
      } catch (e) {
        infoBox.classList.remove('alert-info');
        infoBox.classList.add('alert-warning');
        infoBox.querySelector('span').textContent = 'Error consultando enlace';
      }
    }

    async function handleSubmit(e) {
      e.preventDefault();
      const code = document.getElementById('materia').value;
      const nuevoLink = document.getElementById('nuevoLink').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      if (!code || !nuevoLink) return;
      const materia = Groups.getMateriaByCode(code);
      const btn = e.submitter || document.querySelector('#groupForm button[type="submit"]');
      const original = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Guardando...';
      btn.disabled = true;
      try {
        const plan = document.getElementById('plan').value || '1714';
        const result = await Groups.upsertGroupLink({
          code,
          name: materia ? materia.name : '',
          link: nuevoLink,
          updatedBy: nombre || 'anónimo',
          plan
        });
        await loadCurrentLink(code);
        await renderTabla();
        btn.innerHTML = '<i class="bi bi-check2-circle me-2"></i>Guardado';
        setTimeout(() => { btn.innerHTML = original; btn.disabled = false; }, 1000);
      } catch (err) {
        console.error(err);
        btn.innerHTML = original;
        btn.disabled = false;
        alert('No se pudo guardar el enlace.');
      }
    }

    async function renderTabla() {
      const tbody = document.getElementById('tbodyGrupos');
      tbody.innerHTML = '<tr><td colspan="4" class="text-muted">Cargando...</td></tr>';
      try {
        const plan = document.getElementById('plan').value || '1714';
        const rows = await Groups.fetchAllGroups(plan);
        if (!rows || rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-muted">Sin datos</td></tr>';
          return;
        }
        tbody.innerHTML = rows.map(r => {
          const code = r.code || r.Codigo || r[0];
          const name = r.name || r.Materia || r[1];
          const link = r.link || r.Link || r[2];
          const updated = r.updatedAt || r.Actualizado || r[3] || '';
          const safeLink = link ? `<a href="${link}" target="_blank" class="btn btn-sm btn-outline-primary"><i class=\"bi bi-box-arrow-up-right me-1\"></i>Abrir</a>` : '<span class="text-muted">-</span>';
          return `<tr>
            <td class="text-nowrap">${code || '-'}</td>
            <td>${name || '-'}</td>
            <td class="text-truncate" style="max-width:360px">${link ? `<span class="me-2 small">${link}</span>${safeLink}` : '<span class="text-muted">Sin enlace</span>'}</td>
            <td class="small text-muted">${updated || ''}</td>
          </tr>`;
        }).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-danger">Error al cargar datos</td></tr>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      populateMaterias();
      document.getElementById('materia').addEventListener('change', (e) => {
        if (e.target.value) loadCurrentLink(e.target.value);
      });
      document.getElementById('plan').addEventListener('change', () => {
        populateMaterias();
        document.getElementById('linkActual').querySelector('span').textContent = 'Sin enlace cargado';
        document.getElementById('linkActualHref').classList.add('d-none');
        document.getElementById('materia').value = '';
        renderTabla();
      });
      document.getElementById('groupForm').addEventListener('submit', handleSubmit);
      document.getElementById('btnVerTodos').addEventListener('click', renderTabla);
      renderTabla();

      // Preseleccionar materia por query param ?code=XXXX
      const params = new URLSearchParams(window.location.search);
      const codeParam = params.get('code');
      const planParam = params.get('plan');
      if (planParam) {
        const selPlan = document.getElementById('plan');
        selPlan.value = planParam;
      }
      populateMaterias();
      if (codeParam) {
        const sel = document.getElementById('materia');
        sel.value = codeParam;
        loadCurrentLink(codeParam);
        sel.scrollIntoView({behavior:'smooth', block:'center'});
      }
    });
  </script>
</body>
</html>


