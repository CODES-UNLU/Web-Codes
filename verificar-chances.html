<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Chances - Sorteo Tablet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/styles.css" rel="stylesheet">
    <link href="assets/css/letter-game.css?v=1.0" rel="stylesheet">
    <script>
        (function(){
            try {
                var savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                }
            } catch(e) {}
        })();
    </script>
</head>
<body>
    <button id="darkModeToggle" class="btn btn-outline-secondary position-fixed" style="top: 16px; right: 16px; z-index: 1000;">
        <i class="bi bi-moon"></i>
    </button>
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white text-center">
                        <h4 class="mb-0">
                            <i class="bi bi-search me-2"></i>
                            Consulta tus Chances
                        </h4>
                    </div>
                    <div class="card-body">

                        
                        <div class="text-center mb-4">
                             <p class="text-muted">
                                 Ingresa tu DNI para consultar cuántas chances tienes en el sorteo de la Tablet
                             </p>
                             <div id="fechaActualizacion" class="mt-3" style="display: none;">
                                 <small class="text-info fw-bold">
                                     <i class="bi bi-calendar-check me-1"></i>
                                     Datos actualizados hasta: <span id="fechaDatos" class="text-primary"></span>
                                 </small>
                             </div>
                         </div>
                        
                        <form id="dniForm">
                            <div class="mb-3">
                                <label for="dniInput" class="form-label">
                                    <i class="bi bi-person-badge me-2"></i>
                                    Número de DNI
                                </label>
                                                                 <input 
                                     type="tel" 
                                     class="form-control form-control-lg" 
                                     id="dniInput" 
                                     placeholder="Ej: 12345678"
                                     maxlength="8"
                                     inputmode="numeric"
                                     autocomplete="off"
                                     required
                                 >
                                <div class="form-text">
                                    Ingresa solo números, sin puntos ni espacios
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="bi bi-search me-2"></i>
                                Consultar Chances
                            </button>
                        </form>
                        
                                                 <div id="resultado" class="mt-4" style="display: none;">
                             <div class="alert alert-info">
                                 <h5 class="alert-heading">
                                     <i class="bi bi-info-circle me-2"></i>
                                     Resultado de la Consulta
                                 </h5>
                                 <div id="resultadoContenido"></div>
                                 <div id="fechaResultado" class="mt-2" style="display: none;">
                                     <small class="text-muted">
                                         <i class="bi bi-calendar-x me-1"></i>
                                         <strong>Nota:</strong> Los datos están actualizados hasta <span id="fechaResultadoDatos"></span>. 
                                         Si realizaste tu compra después de esta fecha, tu información aparecerá en la próxima actualización.
                                     </small>
                                 </div>
                             </div>
                         </div>
                        
                                                 <div id="error" class="mt-4" style="display: none;">
                             <div class="alert alert-warning">
                                 <h5 class="alert-heading">
                                     <i class="bi bi-exclamation-triangle me-2"></i>
                                     DNI no encontrado
                                 </h5>
                                 <div id="errorContenido">
                                                                           <p class="mb-2">
                                          El DNI ingresado no se encuentra registrado en el sorteo. 
                                          Asegúrate de haber completado el formulario y realizado el pago correspondiente.
                                      </p>
                                      <p class="text-muted small mb-0">
                                          <i class="bi bi-info-circle me-1"></i>
                                          Si crees que hay un error escribinos a <a href="mailto:codes.unlu@gmail.com">codes.unlu@gmail.com</a> para corregirlo.
                                      </p>
                                     <div id="fechaError" class="mt-2" style="display: none;">
                                         <small class="text-muted">
                                             <i class="bi bi-calendar-x me-1"></i>
                                             <strong>Nota:</strong> Los datos están actualizados hasta <span id="fechaErrorDatos"></span>. 
                                             Si realizaste tu compra después de esta fecha, tu información aparecerá en la próxima actualización.
                                         </small>
                                     </div>
                                 </div>
                             </div>
                         </div>
                        
                        <!-- Top 10 Section -->
                        <div id="top10" class="mt-4" style="display: none;">
                            <div class="card">
                                <div class="card-header bg-success text-white text-center">
                                    <h5 class="mb-0">
                                        <i class="bi bi-trophy me-2"></i>
                                        Top 10 - Más Chances
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="top10Contenido"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <a href="index.html" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>
                        Volver al Inicio
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/letter-game.js?v=1.0"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            var toggle = document.getElementById('darkModeToggle');
            if (!toggle) return;
            var icon = toggle.querySelector('i');
            var current = document.documentElement.getAttribute('data-theme') || 'light';
            if (icon) icon.className = current === 'dark' ? 'bi bi-sun' : 'bi bi-moon';
            toggle.addEventListener('click', function(){
                var theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                if (icon) icon.className = theme === 'dark' ? 'bi bi-sun' : 'bi bi-moon';
            });
        });
    </script>
    <script>
        // Configuración de la API
        const API_CONFIG = {
            // Opción 1: Google Sheets API (requiere configuración)
            sheetsApiUrl: 'https://sheets.googleapis.com/v4/spreadsheets/',
            spreadsheetId: '1rWh1j2LRnkPFthX_OySsO-vqb1FJsuPTeqJVnfhLwSY', // ID de tu Google Sheet
            sheetName: 'verificados', // Nombre de la hoja
            apiKey: 'TU_API_KEY', // Reemplazar con tu API key de Google Cloud
            
            // Opción 2: Google Apps Script (más fácil de configurar)
            appsScriptUrl: 'https://script.google.com/macros/s/AKfycbz9oH5LNKevCJfzolXmBSsxokQe9A69AFRPVZelDHamcB5c1oyunXS13_NS1JdvhGwgpA/exec', // Tu URL de Google Apps Script
            
            // Opción 3: JSON estático (temporal)
            jsonUrl: 'data/sorteo-data.json'
        };

        let datosSorteo = [];
        let isLoading = false;

        // Función para cargar datos desde la API
        async function cargarDatos() {
            try {
                isLoading = true;
                mostrarLoading();
                
                console.log('Iniciando carga de datos...');
                console.log('URL de Apps Script:', API_CONFIG.appsScriptUrl);
                
                // Cargar desde Google Apps Script
                const data = await cargarDesdeAppsScript();
                
                console.log('Respuesta de Apps Script:', data);
                
                if (data && data.length > 0) {
                    datosSorteo = data;
                    console.log('Datos cargados exitosamente:', datosSorteo.length, 'registros');
                    console.log('Primer registro:', datosSorteo[0]);
                    isLoading = false; // Establecer isLoading en false
                    console.log('isLoading establecido en false');
                    ocultarLoading();
                    mostrarTop10(); // Mostrar Top 10 cuando se cargan los datos
                    mostrarFechaActualizacion(); // Mostrar fecha de actualización
                } else {
                    throw new Error('No se pudieron cargar los datos');
                }
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarError('Error al cargar los datos del sorteo. Por favor, intenta más tarde.');
                isLoading = false; // Establecer isLoading en false en caso de error
                ocultarLoading();
            }
        }

        // Función para cargar desde Google Sheets API
        async function cargarDesdeGoogleSheets() {
            const sheetName = encodeURIComponent(API_CONFIG.sheetName);
            const url = `${API_CONFIG.sheetsApiUrl}${API_CONFIG.spreadsheetId}/values/${sheetName}!A:J?key=${API_CONFIG.apiKey}`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.values && data.values.length > 1) {
                return procesarDatosGoogleSheets(data.values);
            }
            return null;
        }

        // Función para cargar desde Google Apps Script
        async function cargarDesdeAppsScript() {
            try {
                console.log('Haciendo fetch a:', API_CONFIG.appsScriptUrl);
                const response = await fetch(API_CONFIG.appsScriptUrl);
                console.log('Status de respuesta:', response.status);
                console.log('Headers de respuesta:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos parseados:', data);
                return data;
            } catch (error) {
                console.error('Error en cargarDesdeAppsScript:', error);
                throw error;
            }
        }

        // Función para cargar desde JSON estático
        async function cargarDesdeJSON() {
            const response = await fetch(API_CONFIG.jsonUrl);
            const data = await response.json();
            return data;
        }

        // Función para procesar datos de Google Sheets
        function procesarDatosGoogleSheets(rows) {
            const headers = rows[0];
            const data = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.length >= 5) {
                    data.push({
                        fecha: row[0] || '',
                        email: row[1] || '',
                        cuil: row[2] || '',
                        dni: row[3] || '',
                        chances: parseInt(row[4]) || 0,
                        numeroOperacion: row[5] || '',
                        estado: row[6] || '',
                        detalleEstado: row[7] || '',
                        valorChances: row[8] || '',
                        tarifa: row[9] || '',
                        montoRecibido: row[10] || ''
                    });
                }
            }
            
            return data;
        }

        // Función para mostrar loading
        function mostrarLoading() {
            const resultadoDiv = document.getElementById('resultado');
            const errorDiv = document.getElementById('error');
            
            resultadoDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Crear indicador de loading si no existe
            if (!document.getElementById('loading')) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loading';
                loadingDiv.className = 'text-center mt-4';
                loadingDiv.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando datos del sorteo...</p>
                `;
                document.querySelector('.card-body').appendChild(loadingDiv);
            }
        }

        // Función para ocultar loading
        function ocultarLoading() {
            const loadingDiv = document.getElementById('loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Función para mostrar error
        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('error');
            const errorHeading = errorDiv.querySelector('.alert-heading');
            const errorText = errorDiv.querySelector('p');
            const fechaError = document.getElementById('fechaError');
            const fechaErrorDatos = document.getElementById('fechaErrorDatos');
            
            errorHeading.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>DNI no encontrado';
            errorText.textContent = mensaje;
            
            // Ocultar la sección de fecha por defecto
            fechaError.style.display = 'none';
            
            // Mostrar fecha de actualización si hay datos disponibles
            if (datosSorteo.length > 0) {
                let fechaMasReciente = null;
                datosSorteo.forEach(registro => {
                    if (registro.fecha) {
                        const fecha = new Date(registro.fecha);
                        if (!fechaMasReciente || fecha > fechaMasReciente) {
                            fechaMasReciente = fecha;
                        }
                    }
                });
                
                if (fechaMasReciente) {
                    const fechaFormateada = fechaMasReciente.toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    
                    fechaErrorDatos.textContent = fechaFormateada;
                    fechaError.style.display = 'block';
                }
            }
            
            errorDiv.style.display = 'block';
        }

        // Función para mostrar fecha de actualización
        function mostrarFechaActualizacion() {
            if (datosSorteo.length === 0) return;
            
            // Encontrar la fecha más reciente en los datos
            let fechaMasReciente = null;
            datosSorteo.forEach(registro => {
                if (registro.fecha) {
                    const fecha = new Date(registro.fecha);
                    if (!fechaMasReciente || fecha > fechaMasReciente) {
                        fechaMasReciente = fecha;
                    }
                }
            });
            
            if (fechaMasReciente) {
                const fechaFormateada = fechaMasReciente.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                document.getElementById('fechaDatos').textContent = fechaFormateada;
                document.getElementById('fechaActualizacion').style.display = 'block';
            }
        }

        // Función para mostrar Top 10
        function mostrarTop10() {
            if (datosSorteo.length === 0) return;
            
            // Agrupar por DNI y sumar chances
            const participantes = {};
            datosSorteo.forEach(registro => {
                if (registro.dni && registro.chances) {
                    if (!participantes[registro.dni]) {
                        participantes[registro.dni] = 0;
                    }
                    participantes[registro.dni] += parseInt(registro.chances) || 0;
                }
            });
            
            // Convertir a array y ordenar por chances (descendente)
            const top10 = Object.entries(participantes)
                .map(([dni, chances]) => ({ dni, chances }))
                .sort((a, b) => b.chances - a.chances)
                .slice(0, 10);
            
            // Crear contenido del Top 10
            let contenido = '<div class="row">';
            
                         // Obtener las chances del líder y determinar las medallas por chances
             const chancesLider = top10[0].chances;
             
             // Encontrar las chances del segundo lugar (primer participante con menos chances que el líder)
             let chancesSegundo = chancesLider;
             for (let i = 1; i < top10.length; i++) {
                 if (top10[i].chances < chancesLider) {
                     chancesSegundo = top10[i].chances;
                     break;
                 }
             }
             
             // Encontrar las chances del tercer lugar (primer participante con menos chances que el segundo)
             let chancesTercero = chancesSegundo;
             for (let i = 0; i < top10.length; i++) {
                 if (top10[i].chances < chancesSegundo && top10[i].chances > 0) {
                     chancesTercero = top10[i].chances;
                     break;
                 }
             }
             
             // Función para determinar la medalla según las chances
             function obtenerMedalla(chances) {
                 if (chances === chancesLider) return '🥇';
                 if (chances === chancesSegundo) return '🥈';
                 if (chances === chancesTercero) return '🥉';
                 return '';
             }
             
             // Primera columna: posiciones 1-5
             contenido += '<div class="col-md-6">';
             for (let i = 0; i < 5 && i < top10.length; i++) {
                 const participante = top10[i];
                 const posicion = i + 1;
                 const medalla = obtenerMedalla(participante.chances);
                 const displayText = medalla || `${posicion}.`;
                 
                 contenido += `
                     <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                         <div>
                             <span class="fw-bold">${displayText}</span>
                             <span class="text-muted">Participante ${posicion}</span>
                         </div>
                         <div>
                             <span class="badge bg-primary fs-6">${participante.chances} chances</span>
                         </div>
                     </div>
                 `;
             }
             contenido += '</div>';
             
             // Segunda columna: posiciones 6-10
             contenido += '<div class="col-md-6">';
             for (let i = 5; i < 10 && i < top10.length; i++) {
                 const participante = top10[i];
                 const posicion = i + 1;
                 const medalla = obtenerMedalla(participante.chances);
                 const displayText = medalla || `${posicion}.`;
                 
                 contenido += `
                     <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2">
                         <div>
                             <span class="fw-bold">${displayText}</span>
                             <span class="text-muted">Participante ${posicion}</span>
                         </div>
                         <div>
                             <span class="badge bg-primary fs-6">${participante.chances} chances</span>
                         </div>
                     </div>
                 `;
             }
            contenido += '</div>';
            
            contenido += '</div>';
            
            // Mostrar Top 10
            const top10Div = document.getElementById('top10');
            const top10Contenido = document.getElementById('top10Contenido');
            top10Contenido.innerHTML = contenido;
            top10Div.style.display = 'block';
        }

        // Event listener para el formulario
        document.getElementById('dniForm').addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Formulario enviado');
            
            console.log('Estado de isLoading:', isLoading);
            if (isLoading) {
                console.log('Sistema cargando, ignorando submit');
                return;
            }
            
            const dni = document.getElementById('dniInput').value.trim();
            console.log('DNI ingresado:', dni);
            console.log('Datos disponibles:', datosSorteo.length, 'registros');
            
            const resultadoDiv = document.getElementById('resultado');
            const errorDiv = document.getElementById('error');
            const resultadoContenido = document.getElementById('resultadoContenido');
            
            // Ocultar resultados anteriores
            resultadoDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            if (datosSorteo.length === 0) {
                console.log('No hay datos disponibles');
                mostrarError('Los datos del sorteo no están disponibles. Por favor, intenta más tarde.');
                return;
            }
            
            // Buscar el DNI en los datos
            const registros = datosSorteo.filter(registro => registro.dni === dni);
            console.log('Registros encontrados para DNI', dni, ':', registros);
            
            if (registros.length > 0) {
                // Sumar todas las chances para este DNI
                const totalChances = registros.reduce((sum, registro) => sum + registro.chances, 0);
                console.log('Total de chances:', totalChances);
                
                // Calcular posición y distancia del líder
                const participantes = {};
                datosSorteo.forEach(registro => {
                    if (registro.dni && registro.chances) {
                        if (!participantes[registro.dni]) {
                            participantes[registro.dni] = 0;
                        }
                        participantes[registro.dni] += parseInt(registro.chances) || 0;
                    }
                });
                
                const ranking = Object.entries(participantes)
                    .map(([dni, chances]) => ({ dni, chances }))
                    .sort((a, b) => b.chances - a.chances);
                
                const lider = ranking[0];
                const posicionUsuario = ranking.findIndex(p => p.dni === dni) + 1;
                const distanciaDelLider = lider.chances - totalChances;
                
                console.log('Líder:', lider);
                console.log('Posición del usuario:', posicionUsuario);
                console.log('Chances del usuario:', totalChances);
                console.log('¿Es líder?', totalChances === lider.chances);
                
                // Crear el contenido del resultado
                let contenido = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>DNI:</strong> ${dni}</p>
                            <p><strong>Total de Chances:</strong> <span class="badge bg-success fs-6">${totalChances}</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Registros encontrados:</strong> ${registros.length}</p>
                        </div>
                    </div>
                `;
                
                // Verificar si el usuario es líder (tiene las mismas chances que el líder)
                const esLider = totalChances === lider.chances;
                
                if (esLider) {
                    // Calcular cuántos participantes comparten el podio con el líder
                    const participantesConMismasChances = ranking.filter(p => p.chances === lider.chances).length;
                    
                    console.log('Usuario es líder. Chances del líder:', lider.chances);
                    console.log('Participantes con mismas chances:', participantesConMismasChances);
                    console.log('Ranking completo:', ranking);
                    
                    let mensajeLider = '<strong>¡Líder del sorteo!</strong> Tienes la mayor cantidad de chances.';
                    if (participantesConMismasChances > 1) {
                        const otrosParticipantes = participantesConMismasChances - 1; // Excluir al usuario del conteo
                        mensajeLider += ` Compartes podio con ${otrosParticipantes} participantes.`;
                        console.log('Mensaje con empate:', mensajeLider);
                    } else {
                        console.log('Mensaje sin empate:', mensajeLider);
                    }
                    
                    contenido += `
                        <div class="mt-3">
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-trophy me-2"></i>
                                ${mensajeLider}
                            </div>
                        </div>
                    `;
                } else {
                    contenido += `
                        <div class="mt-3">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-arrow-up me-2"></i>
                                <strong>${distanciaDelLider} chances</strong> detrás del líder (${lider.chances} chances)
                            </div>
                        </div>
                    `;
                }
                
                if (registros.length > 1) {
                    contenido += `
                        <div class="mt-3">
                            <p class="text-muted small">
                                <i class="bi bi-info-circle me-1"></i>
                                Si crees que hay un error escribinos a <a href="mailto:codes.unlu@gmail.com">codes.unlu@gmail.com</a> para corregirlo.
                            </p>
                        </div>
                    `;
                }
                
                                 // Mostrar fecha de actualización en el resultado
                 const fechaResultado = document.getElementById('fechaResultado');
                 const fechaResultadoDatos = document.getElementById('fechaResultadoDatos');
                 
                 if (datosSorteo.length > 0) {
                     let fechaMasReciente = null;
                     datosSorteo.forEach(registro => {
                         if (registro.fecha) {
                             const fecha = new Date(registro.fecha);
                             if (!fechaMasReciente || fecha > fechaMasReciente) {
                                 fechaMasReciente = fecha;
                             }
                         }
                     });
                     
                     if (fechaMasReciente) {
                         const fechaFormateada = fechaMasReciente.toLocaleDateString('es-ES', {
                             day: '2-digit',
                             month: '2-digit',
                             year: 'numeric'
                         });
                         
                         fechaResultadoDatos.textContent = fechaFormateada;
                         fechaResultado.style.display = 'block';
                     }
                 }
                 
                 // Agregar botón para comprar más chances
                 contenido += `
                     <div class="mt-4 text-center">
                         <a href="sorteo.html" class="btn btn-success btn-lg">
                             <i class="bi bi-plus-circle me-2"></i>
                             Comprar Más Chances
                         </a>
                         <p class="text-muted small mt-2">
                             <i class="bi bi-info-circle me-1"></i>
                             Aumenta tus probabilidades de ganar la Tablet
                         </p>
                     </div>
                 `;
                 
                 resultadoContenido.innerHTML = contenido;
                 resultadoDiv.style.display = 'block';
                 console.log('Resultado mostrado exitosamente');
            } else {
                console.log('DNI no encontrado');
                mostrarError('El DNI ingresado no se encuentra registrado en el sorteo. Asegúrate de haber completado el formulario y realizado el pago correspondiente.');
            }
        });
        
        // Validación en tiempo real del DNI
        document.getElementById('dniInput').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Solo números
            e.target.value = value;
        });

        // Cargar datos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, iniciando carga de datos...');
            cargarDatos();
        });
    </script>
</body>
</html>
